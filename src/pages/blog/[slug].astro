---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import Comments from "../../components/Comments.astro";
import ColorThief from 'colorthief';
import path from 'node:path';
import fs from 'node:fs';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(({ slug }) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const post = await (await import('astro:content')).getEntry('blog', slug);

const { Content } = await post.render();
const { title, date, tags, image, description } = post.data;

let accent = '#e5e7eb';
let accent2 = '#d1d5db';
const imgPath = path.join(process.cwd(), 'public', image.replace(/^\//, ''));

if (fs.existsSync(imgPath)) {
  try {
    const [dom, ...rest] = await ColorThief.getPalette(imgPath, 6);
    const sec = rest?.[0] ?? dom;
    accent  = `rgb(${dom[0]}, ${dom[1]}, ${dom[2]})`;
    accent2 = `rgb(${sec[0]}, ${sec[1]}, ${sec[2]})`;
  } catch {}
}

// content gradient derived from accent2
const contentGrad = `
  linear-gradient(
    180deg,
    color-mix(in oklab, ${accent2} 100%, white 0%),
    color-mix(in oklab, ${accent2} 100%,  white 0%)
  )
`;

let heroMode: 'cover' | 'contain' = 'cover';
---

<Layout
  {title}
  {description}
  overlapHeader={false}
  style={`--accent:${accent}; --accent2:${accent2}; --contentGrad:${contentGrad};`}
  >
  {/* SIMPLE POST IMAGE â€” no full-bleed, no masks, no gradients */}
  {image && (
    <figure class="mx-auto w-full max-w-5xl px-6 mt-6">
      <img
        src={image}
        alt={title}
        class="block w-full rounded-xl border border-zinc-200 object-cover"
        loading="eager"
        decoding="async"
        fetchpriority="high"
      />
    </figure>
  )}


    <!-- CONTENT -->
  <article class="relative mx-auto max-w-3xl px-6 pb-20 pt-10">
    <div class="pointer-events-none absolute inset-0 -z-10" style="background: var(--contentGrad)"></div>

    <a href="/blog" class="inline-flex items-center gap-2 rounded-lg border border-zinc-200/70 px-3 py-1.5 text-sm text-zinc-700 hover:bg-white/60 hover:shadow-sm transition dark:border-zinc-800">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
        <path d="M15.75 19.5 8.25 12l7.5-7.5"/>
      </svg>
      Back to Blog
    </a>

    <header class="mt-6 mb-6">
      <h1 class="text-4xl font-bold tracking-tight text-zinc-900">{title}</h1>
      <time class="mt-2 block text-[0.92rem] text-zinc-500">
        {date.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' })}
      </time>
    </header>

    {tags?.length ? (
      <div class="mb-8 flex flex-wrap gap-2">
        {tags.map((t: string) => (
          <span class="rounded-full border border-zinc-200/70 bg-white/60 px-3 py-1 text-xs font-medium text-zinc-700 shadow-sm">
            {t}
          </span>
        ))}
      </div>
    ) : null}

    <div class="prose prose-zinc max-w-none prose-headings:scroll-mt-24 dark:prose-invert">
      <Content />
    </div>

    <div class="mt-12">
      <Comments
        repo="anuj-nk/anuj-nk.github.io"
        repoId="R_kgDOO-p9mA"
        category="Comments"
        categoryId="DIC_kwDOO-p9mM4Cv-pc"
        mapping="pathname"
      />
    </div>
  </article>
</Layout>
